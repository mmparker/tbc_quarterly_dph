

<style type="text/css">

body {
  padding-bottom: 20%;
}

table {
  margin-left: auto;
  margin-right: auto;
  border: 1px solid #808080;
  border-collapse: collapse;
}

th {
  background-color: #31A354;
  color: #FFFFFF;
  border: 1px solid #808080;
  padding-right: 20px;
  padding-left: 20px;
}

td {
  border: 1px solid #808080;
  padding-right: 20px;
  padding-left: 20px;
}

img {
  margin-left: auto;
  margin-right: auto;
}

p {
  text-align:center;
}


h1 {
  text-align: center;
  padding-top: 0px;
}

h2 {
  text-align: center;
  padding-top: 80px;
}

h3, h4 {
  text-align: center;
  padding-top: 30px;
}

hr {
  border: 0;
  height: 1px;
  background: #333;
  background-image: -webkit-linear-gradient(left, #ccc, #333, #ccc); 
  background-image:    -moz-linear-gradient(left, #ccc, #333, #ccc); 
  background-image:     -ms-linear-gradient(left, #ccc, #333, #ccc); 
  background-image:      -o-linear-gradient(left, #ccc, #333, #ccc); 
}

</style>



# Denver Metro TB Control Program
# Quarterly Strategic Area Review
### First Quarter, 2013

```{r setup, echo=FALSE,results='hide', message=FALSE}
options(stringsAsFactors = FALSE)

# For the report
library(knitr)
library(xtable)

# For graphics
library(ggplot2)
library(gridExtra)

# For aggregation
library(plyr)
library(reshape2)


# Set default chunk options
opts_chunk$set(echo = FALSE,
               comment = "",
               message = FALSE,
               warning = TRUE,
               error = TRUE,
               fig.width = 10,
               dev="svg",
               cache = FALSE)



# Set some plot parameters that will want tweaking
point_size <- 3
line_size <- 1.3
colorwheel <- c("#31A354", "#ADDD8E", "#F03B20", "#43A2CA")



start_date <- as.Date("2011-01-01")
stop_date <- as.Date("2013-03-31")


# A function for pretty-printing data.frames
dfprint <- function(df, printdigits = 2) {
    print(
        xtable(format(df, 
                      na.encode = FALSE, 
                      digits = printdigits, 
                      nsmall = printdigits), 
               align = c("l", "l", rep("c", ncol(df) - 1))
        ),
        type = "html",
        include.rownames = FALSE,
        NA.string = "-")
}

theme_tb <- theme_bw() +
            theme(legend.key.width = unit(.75, "inches"))

```



## TB Cases in the Denver Metropolitan Area
-------------------------------------------

```{r cases}
source("fun/query_actives.r")


actives <- query_actives(start_date = start_date,
                         stop_date = stop_date)

metroactives <- subset(actives, metro_case %in% 'True')


# Temporary adjustment
blank <- rep(NA, 6)
actives_adj <- data.frame(mrn = blank,
                          person_id = blank,
                          last_name = c("IBOBO", "THEN", "KINGMAN", "HASSAN", "KAME", "ZENG"),
                          first_name = blank,
                          date_of_birth = blank,
                          date_counted = blank,
                          tx_start_date = blank,
                          report_county = c("Arapahoe", "Denver", "Denver", "Arapahoe", "Adams",
                                            "Boulder"),
                          metro_case = "True",
                          date_id = blank,
                          mon_id = blank,
                          yr_id = 2013,
                          qtr_id = 1
)

metroactives <- rbind(metroactives, actives_adj)

# Create a quarter label
metroactives$plot_qtr <- with(metroactives, paste(yr_id, " Q", qtr_id, sep = ""))

# Create plot labels for county
metroactives$plot_group <- NA
metroactives$plot_group[metroactives$report_county %in% "Denver"] <- "Denver"
metroactives$plot_group[!metroactives$report_county %in% "Denver"] <- "Other Metro Counties"


# Aggregate
actives_count <- count(metroactives, "plot_qtr")



```


```{r total_cases}

ggplot(actives_count, aes(x = plot_qtr, y = freq, group = 1)) +
    geom_point(size = point_size, color = "#31A354") +
    geom_line(size = line_size, color = "#31A354") +
    expand_limits(y = 0) +
    labs(x = "Quarter identified (earliest of date treatment started or date case reported)", 
         y = "Number of cases",
         title = "Active TB in Metropolitan Denver") +
    theme_tb


```



```{r case_rates}

# Read in the population estimates
pop <- read.csv("data/metro_pop_estimates.csv")

# Aggregate
metro_pop <- ddply(pop, .var = "year", .fun = summarise, metro_pop = sum(population))


# Merge and calculate the case rates
actives_count$year <- substr(actives_count$plot_qtr, 1, 4)

actives_rate <- merge(x = actives_count,
                      y = metro_pop,
                      by = "year",
                      all.x = TRUE)

# Fill in any years with missing population estimates using the previous years
actives_rate$metro_pop[is.na(actives_rate$metro_pop)] <-
  actives_rate$metro_pop[!is.na(actives_rate$metro_pop)][sum(!is.na(actives_rate$metro_pop))]


# Calculate rates
actives_rate$rate_pht <- with(actives_rate, freq / metro_pop * 1e5)
actives_rate$rate_pht_annualized <- with(actives_rate, freq / metro_pop * 4e5)


# Plot it
# ggplot(actives_rate, aes(x = plot_qtr, y = rate_pht_annualized, group = 1)) +
#   geom_point(size = point_size, color = "#31A354") +
#   geom_line(size = line_size, color = "#31A354") +
#   expand_limits(y = 0) +
#   labs(x = "Quarter identified (earliest of date treatment started or date case reported)", 
#        y = "Annualized rate per 100,000 residents",
#        title = "Rates of Active TB in Metropolitan Denver") +
#   theme_tb
```



```{r cases_by_county}
ggplot(metroactives, aes(x = plot_qtr, fill = plot_group)) +
    geom_bar(color = "black") +
    stat_bin(geom="text", aes(label=..count.., vjust = 1.25)) +
    scale_fill_manual("Patient's Residence", values = c("#ADDD8E", "#31A354")) +
    labs(x = "Quarter Identified (earliest of date treatment started or date case reported)", 
         y = "Number of cases",
         title = "Reported TB Cases by County of Residence") +
    theme_tb
```



```{r,results='asis'}


actives_print <- ddply(metroactives, .var = "plot_qtr", .fun = summarise,
                       total = length(report_county),
                       denver = sum(report_county %in% 'Denver'),
                       metro = total - denver)

actives_print <- merge(x = actives_print,
                       y = actives_rate[ , c("plot_qtr", "rate_pht_annualized")],
                       by = "plot_qtr",
                       all.x = TRUE)
                       

# Print it with nice names
names(actives_print) <- c("Quarter", "Total Cases", "Denver", "Other Metro Counties",
                          "Annualized Rate per 100k")

dfprint(xtable(actives_print))


```



## Visits - Clinic vs. Outreach
-------------------------------------------

```{r visits_inout}


source("fun/query_visits.r")

visits <- query_visits(start_date = start_date,
                       stop_date = stop_date)

visits$plot_qtr <- with(visits, paste(visit_yr, " Q", visit_qtr, sep = ""))

locagg <- count(subset(visits, location %in% c("Clinic", "Outreach")),
                vars = c("plot_qtr", "location"))

qtragg <- count(subset(visits, location %in% c("Clinic", "Outreach")),
                vars = "plot_qtr")

qtragg$location <- "All Visits"

visitagg <- rbind(locagg, qtragg)

ggplot(visitagg, aes(x = plot_qtr, y = freq, group = location, color = location)) +
    geom_point(size = point_size) +
    geom_line(aes(linetype = location), size = line_size) +
    expand_limits(y = 0) +
    scale_color_manual("Visit Location", values = colorwheel[1:3]) +
    scale_linetype_discrete("Visit Location") +
    labs(x = "Visit date", 
         y = "Number of visits",
         title = "Patient Visits by Location") +
    theme_tb
```


```{r, results='asis'}

# Cast visits wide
visits_wide <- dcast(visitagg, plot_qtr ~ location, value.var = "freq")

# Pretty-print
names(visits_wide) <- c("Quarter", "Total Visits", "Clinic Visits", "Outreach Visits")

dfprint(visits_wide)

```


## Screenings for Active and Latent Tuberculosis
-------------------------------------------
```{r screens}

# Load the function
source("fun/query_tests.r")

# Query test results for the period
tests <- query_tests(start_date = start_date,
                     stop_date = stop_date)

# Convert date to quarter
tests$plot_qtr <- with(tests, paste(test_yr, " Q", test_qtr, sep = ""))

# Aggregate by quarter
testagg <- count(tests, vars = c("test", "plot_qtr"))


# Plot it
ggplot(testagg, aes(x = plot_qtr, y = freq, group = test, color = test)) +
    geom_point(size = point_size) +
    geom_line(aes(linetype = test), size = line_size) +
    expand_limits(y = 0) +
    scale_color_manual("Diagnostic", values = colorwheel[1:3]) +
    scale_linetype_discrete("Diagnostic") +
    labs(x = "Diagnostic date", 
         y = "Number of diagnostics",
         title = "Screenings for Active and Latent Tuberculosis") +
    theme_tb
```


```{r, results='asis'}

# Cast tests wide
tests_wide <- dcast(testagg, plot_qtr ~ test, value.var = "freq")

# Pretty-print
names(tests_wide) <- c("Quarter", "CXRs", "QFTs", "TSTs")

dfprint(tests_wide)

```





## Treatment Initiation and Completion
-------------------------------------------

```{r}

source("fun/query_tx_plans.r")

# 
plans <- query_tx_plans(start_date = start_date,
                        stop_date = stop_date)


# Create a quarter label
plans$plot_qtr <- with(plans, paste(plan_yr, " Q", plan_qtr, sep = ""))

plan_summary <- ddply(plans, .var = "plot_qtr", .fun = summarise,
                      Active = sum(treat_plan_type %in% "Active"),
                      LTBI = sum(treat_plan_type %in% "LTBI"),
                      RIF = sum(ltbi_drug %in% "RIF"),
                      INH = sum(ltbi_drug %in% "INH"),
                      `INH/Rifapentine` = sum(ltbi_drug %in% "INH/Rifapentine")
)


```

### Treatment Initiation - Active and Latent

```{r}

plan_melt <- melt(plan_summary, id.var = "plot_qtr")

act_ltbi_init <- subset(plan_melt, variable %in% c("Active", "LTBI"))


ggplot(act_ltbi_init, aes(x = plot_qtr, y = value, group = variable, color = variable)) +
    geom_point(size = point_size) +
    geom_line(aes(linetype = variable), size = line_size) +
    expand_limits(y = 0) +
    scale_color_manual("Plan Type", values = colorwheel[1:2]) +
    scale_linetype_manual("Plan Type", values = c(1, 2)) +
    labs(x = "Quarter initiated", 
         y = "Number of patients",
         title = "Treatment Plans Initiated by Type") +
    theme_tb

```



### Active Treatment Completion

```{r}


# Calculate completion rates for active tx
act_comp <- ddply(subset(plans, treat_plan_type %in% "Active"),
                 .var = "plot_qtr", .fun = summarise,
                 n = sum(completion_status %in% c("Completed", "Not Completed", "Ongoing")),
                 n_complete = sum(completion_status %in% "Completed"),
                 n_incomplete = sum(completion_status %in% "Not Completed"),
                 n_ongoing = sum(completion_status %in% "Ongoing"),
                 per_complete = n_complete / n * 100)


# Plot it
ggplot(act_comp, aes(x = plot_qtr, y = per_complete, group = 1)) +
 geom_point(size = point_size, color = colorwheel[1]) +
 geom_line(size = line_size, color = colorwheel[1]) +
 expand_limits(y = c(0, 100)) +
 labs(x = "Quarter",
      y = "Percent Completed",
      title = "Completion of Active Therapy") +
 theme_tb


```



### LTBI Treatment Completion

```{r}


# Calculate completion rates for active tx
ltbi_comp <- ddply(subset(plans, ltbi_drug %in% c("RIF", "INH", "INH/Rifapentine")),
                   .var = c("ltbi_drug", "plot_qtr"),
                   .fun = summarise,
                   
           n = sum(completion_status %in% c("Completed", "Not Completed", "Ongoing")),
           n_complete = sum(completion_status %in% "Completed"),
           n_incomplete = sum(completion_status %in% "Not Completed"),
           n_ongoing = sum(completion_status %in% "Ongoing"),
           per_complete = n_complete / n * 100
)


# Plot it
ggplot(ltbi_comp, aes(x = plot_qtr, y = per_complete, group = ltbi_drug, color = ltbi_drug)) +
    geom_point(size = point_size) +
    geom_line(aes(linetype = ltbi_drug), size = line_size) +
    expand_limits(y = c(0, 100)) +
    scale_color_manual("Regimen", values = colorwheel[1:3]) +
    scale_linetype_discrete("Regimen") +
    labs(x = "Quarter",
         y = "Percent Completed",
         title = "Completion of LTBI Therapy") +
    theme_tb


```